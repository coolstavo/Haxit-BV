<!doctype html>
<html xmlns:th="http://www.thymeleaf.org" lang="nl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Listen - Muziek Platform</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <link rel="stylesheet" th:href="@{/css/style.css}" />
  </head>
  <body class="bg">
    <!-- Navbar -->
    <div th:insert="~{fragments/_navbar :: navbar}"></div>

    <div class="container-fluid px-4">
      <div th:if="${loginRequired}" class="alert alert-warning">
        Log in om je profiel te bekijken.
      </div>
      <div class="row">
        <div class="col-md-8 mb-4">
          <div class="card shadow-sm">
            <div class="card-body p-0">
              <div id="map"></div>
            </div>
          </div>
        </div>

        <div class="col-md-4">
          <!-- Search Box -->
          <div th:insert="~{fragments/_searchbox :: searchbox}"></div>

          <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="mb-0">Actuele Opdrachten & Lessen</h4>
          </div>
          <div class="list-group overflow-auto" style="max-height: 85vh">
            <!-- Events -->
            <div
              class="list-group-item event-card border-0 shadow-sm mb-2 rounded position-relative"
              th:each="event, iterStat : ${events}"
              style="cursor: pointer"
            >
              <div
                th:data-id="${event.id}"
                th:data-lat="${event.lat}"
                th:data-lng="${event.lng}"
                th:data-index="${iterStat.index}"
                th:data-type="event"
                onclick="
                  focusOnMap(
                    this.dataset.lat,
                    this.dataset.lng,
                    this.dataset.type + '-' + this.dataset.index,
                  )
                "
              >
                <div
                  class="d-flex w-100 justify-content-between align-items-start"
                >
                  <div class="flex-grow-1">
                    <h5 class="mb-1 text-dark" th:text="${event.title}">
                      Titel
                    </h5>
                    <span
                      class="badge rounded-pill navbar-brown"
                      th:text="event"
                      >Type</span
                    >
                  </div>
                  <form
                    method="post"
                    th:action="@{'/event/' + ${event.id}  + '/like?redirect=home'}"
                    class="m-0"
                    onclick="event.stopPropagation()"
                  >
                    <button
                      type="submit"
                      class="btn btn-sm"
                      th:classappend="${eventUserLikes.contains(event.id)} ? 'btn-danger' : 'btn-outline-danger'"
                      style="min-width: 60px"
                    >
                      <span th:if="${eventUserLikes.contains(event.id)}"
                        >‚ù§Ô∏è
                        <span th:text="${eventLikeCounts[event.id]}"
                          >0</span
                        ></span
                      >
                      <span th:if="${!eventUserLikes.contains(event.id)}"
                        >ü§ç
                        <span th:text="${eventLikeCounts[event.id]}"
                          >0</span
                        ></span
                      >
                    </button>
                  </form>
                </div>
                <p class="mb-1" th:text="${event.description}">Beschrijving</p>

                <!-- Instruments -->
                <div
                  th:if="${event.instruments != null && !event.instruments.isEmpty()}"
                >
                  <span
                    th:each="instrument : ${event.instruments}"
                    class="badge bg-primary me-1"
                    th:text="${instrument.naam}"
                  ></span>
                </div>

                <!-- Genres -->
                <div
                  th:if="${event.genres != null && !event.genres.isEmpty()}"
                  class="mt-1"
                >
                  <span
                    th:each="genre : ${event.genres}"
                    class="badge bg-secondary me-1"
                    th:text="${genre.name}"
                  ></span>
                </div>
              </div>
            </div>

            <!-- Jams -->
            <div
              class="list-group-item event-card border-0 shadow-sm mb-2 rounded position-relative"
              th:each="jam, iterStat : ${jams}"
              style="cursor: pointer"
            >
              <div
                th:data-id="${jam.id}"
                th:data-lat="${jam.lat}"
                th:data-lng="${jam.lng}"
                th:data-index="${iterStat.index}"
                th:data-type="jam"
                onclick="
                  focusOnMap(
                    this.dataset.lat,
                    this.dataset.lng,
                    this.dataset.type + '-' + this.dataset.index,
                  )
                "
              >
                <div
                  class="d-flex w-100 justify-content-between align-items-start"
                >
                  <div class="flex-grow-1">
                    <h5 class="mb-1 text-dark" th:text="${jam.title}">Titel</h5>
                    <span class="badge rounded-pill bg-warning text-dark"
                      >Jam</span
                    >
                  </div>
                  <form
                    method="post"
                    th:action="@{'/jam/' + ${jam.id} + '/like?redirect=home'}"
                    class="m-0"
                    onclick="event.stopPropagation()"
                  >
                    <button
                      type="submit"
                      class="btn btn-sm"
                      th:classappend="${jamUserLikes.contains(jam.id)} ? 'btn-danger' : 'btn-outline-danger'"
                      style="min-width: 60px"
                    >
                      <span th:if="${jamUserLikes.contains(jam.id)}"
                        >‚ù§Ô∏è
                        <span th:text="${jamLikeCounts[jam.id]}">0</span></span
                      >
                      <span th:if="${!jamUserLikes.contains(jam.id)}"
                        >ü§ç
                        <span th:text="${jamLikeCounts[jam.id]}">0</span></span
                      >
                    </button>
                  </form>
                </div>
                <p class="mb-1" th:text="${jam.description}">Beschrijving</p>

                <!-- Instruments -->
                <div
                  th:if="${jam.instruments != null && !jam.instruments.isEmpty()}"
                >
                  <span
                    th:each="instrument : ${jam.instruments}"
                    class="badge bg-primary me-1"
                    th:text="${instrument.naam}"
                  ></span>
                </div>

                <!-- Genres -->
                <div
                  th:if="${jam.genres != null && !jam.genres.isEmpty()}"
                  class="mt-1"
                >
                  <span
                    th:each="genre : ${jam.genres}"
                    class="badge bg-secondary me-1"
                    th:text="${genre.name}"
                  ></span>
                </div>
              </div>
            </div>

            <!-- Lessons -->
            <div
              class="list-group-item event-card border-0 shadow-sm mb-2 rounded position-relative"
              th:each="lesson, iterStat : ${lessons}"
              style="cursor: pointer"
            >
              <div
                th:data-id="${lesson.id}"
                th:data-lat="${lesson.lat}"
                th:data-lng="${lesson.lng}"
                th:data-index="${iterStat.index}"
                th:data-type="lesson"
                onclick="
                  focusOnMap(
                    this.dataset.lat,
                    this.dataset.lng,
                    this.dataset.type + '-' + this.dataset.index,
                  )
                "
              >
                <div
                  class="d-flex w-100 justify-content-between align-items-start"
                >
                  <div class="flex-grow-1">
                    <h5 class="mb-1 text-dark">
                      <span th:text="${lesson.instrument?.naam}"
                        >Instrument</span
                      >
                      Les
                    </h5>
                    <div class="mb-2">
                      <span class="badge rounded-pill bg-success me-1"
                        >Les</span
                      >
                      <span class="badge bg-primary">
                        <i class="bi bi-music-note-beamed me-1"></i>
                        <span th:text="${lesson.instrument?.naam}"
                          >Instrument</span
                        >
                      </span>
                    </div>
                  </div>
                  <form
                    method="post"
                    th:action="@{'/lesson/' + ${lesson.id} + '/like?redirect=home'}"
                    class="m-0"
                    onclick="event.stopPropagation()"
                  >
                    <button
                      type="submit"
                      class="btn btn-sm"
                      th:classappend="${lessonUserLikes.contains(lesson.id)} ? 'btn-danger' : 'btn-outline-danger'"
                      style="min-width: 60px"
                    >
                      <span th:if="${lessonUserLikes.contains(lesson.id)}"
                        >‚ù§Ô∏è
                        <span th:text="${lessonLikeCounts[lesson.id]}"
                          >0</span
                        ></span
                      >
                      <span th:if="${!lessonUserLikes.contains(lesson.id)}"
                        >ü§ç
                        <span th:text="${lessonLikeCounts[lesson.id]}"
                          >0</span
                        ></span
                      >
                    </button>
                  </form>
                </div>
                <p class="mb-1">
                  <strong th:text="${lesson.docent.user.username}"
                    >Docent</strong
                  >
                  - ‚Ç¨<span
                    th:text="${#numbers.formatDecimal(lesson.rate, 1, 2)}"
                    >0.00</span
                  >
                  <span th:text="${lesson.rateType}">per uur</span>
                </p>
                <small
                  class="text-muted"
                  th:if="${lesson.location}"
                  th:text="${lesson.location}"
                  >Locatie</small
                >
                <small
                  class="text-muted d-block"
                  th:if="${lesson.levels}"
                  th:text="'Niveaus: ' + ${lesson.levels}"
                ></small>

                <!-- Genres -->
                <div
                  th:if="${lesson.genres != null && !lesson.genres.isEmpty()}"
                  class="mt-1"
                >
                  <span
                    th:each="genre : ${lesson.genres}"
                    class="badge bg-secondary me-1"
                    th:text="${genre.name}"
                  ></span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Hidden data containers for JavaScript -->
    <div
      id="eventsData"
      th:each="event : ${events}"
      th:data-id="${event.id}"
      th:data-title="${event.title}"
      th:data-description="${event.description}"
      th:data-lat="${event.lat}"
      th:data-lng="${event.lng}"
      style="display: none"
    ></div>

    <div
      id="lessonsData"
      th:each="lesson : ${lessons}"
      th:data-id="${lesson.id}"
      th:data-instrument="${lesson.instrument?.naam}"
      th:data-rate="${lesson.rate}"
      th:data-ratetype="${lesson.rateType}"
      th:data-location="${lesson.location}"
      th:data-lat="${lesson.lat}"
      th:data-lng="${lesson.lng}"
      th:data-docentnaam="${lesson.docent.user.username}"
      style="display: none"
    ></div>

    <div
      id="jamsData"
      th:each="jam : ${jams}"
      th:data-id="${jam.id}"
      th:data-title="${jam.title}"
      th:data-description="${jam.description}"
      th:data-lat="${jam.lat}"
      th:data-lng="${jam.lng}"
      style="display: none"
    ></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script th:inline="javascript">
      var pinIconUrl = /*[[@{/assets/pin-red.png}]]*/ "/assets/pin-red.png";
      var username = /*[[${username}]]*/ "";
    </script>
    <script th:src="@{/js/map.js}"></script>
  </body>
</html>
