<!doctype html>
<html xmlns:th="http://www.thymeleaf.org" lang="nl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bedrijfsprofiel</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <link rel="stylesheet" th:href="@{/css/style.css}" />
    <style>
      #eventMap {
        height: 300px;
        width: 100%;
        border-radius: 8px;
        margin-bottom: 15px;
      }
    </style>
  </head>
  <body class="bg">
    <div th:insert="~{fragments/_navbar :: navbar}"></div>

    <div class="container mt-4">
      <h3 class="mb-3">
        Bedrijfsprofiel van <span th:text="${companyName}">Bedrijf</span>
      </h3>

      <!-- View Mode -->
      <div th:if="${!edit}" class="card shadow-sm mb-4">
        <div class="card-body">
          <div th:if="${!hasData && isOwner}">
            <p class="text-muted">Nog geen gegevens ingevuld</p>
            <a
              th:href="@{'/profile/' + ${companyName} + '/edit'}"
              class="btn btn-primary"
              >Profiel Invullen</a
            >
          </div>

          <div th:if="${hasData}">
            <div class="row">
              <div class="col-md-3">
                <div th:if="${company.logo}" class="mb-3">
                  <img
                    th:src="@{'/api/company/logo/' + ${company.id}}"
                    alt="Logo"
                    class="img-fluid"
                    style="max-width: 150px; border-radius: 8px"
                  />
                </div>
                <div th:unless="${company.logo}" class="mb-3">
                  <div
                    class="bg-light p-3 text-center rounded"
                    style="
                      width: 150px;
                      height: 150px;
                      display: flex;
                      align-items: center;
                      justify-content: center;
                    "
                  >
                    <small class="text-muted">Geen logo</small>
                  </div>
                </div>
              </div>
              <div class="col-md-9">
                <p>
                  <strong>Locatie:</strong>
                  <span th:text="${company.location}">-</span>
                </p>
                <p th:if="${company.websiteUrl}">
                  <strong>Website:</strong>
                  <a
                    th:href="${company.websiteUrl}"
                    th:text="${company.websiteUrl}"
                    target="_blank"
                    rel="noopener"
                    >-</a
                  >
                </p>
                <p th:if="${company.genres}">
                  <strong>Gezochte genres:</strong>
                  <span th:text="${company.genres}">-</span>
                </p>
              </div>
            </div>

            <div class="mt-4">
              <h5>Over ons</h5>
              <p style="white-space: pre-line" th:text="${company.aboutUs}">
                -
              </p>
            </div>

            <div class="mt-4">
              <h5>Gezochte muzikanten</h5>
              <p
                style="white-space: pre-line"
                th:text="${company.musiciansWanted}"
              >
                -
              </p>
            </div>

            <a
              th:if="${isOwner}"
              th:href="@{'/profile/bedrijf/' + ${companyName} + '/edit'}"
              class="btn btn-primary mt-4"
              >Bewerken</a
            >
          </div>
        </div>
      </div>

      <!-- Edit Mode -->
      <div th:if="${edit}" class="card shadow-sm">
        <div class="card-body">
          <form
            method="post"
            action="/profile/bedrijf/save"
            enctype="multipart/form-data"
          >
            <input type="hidden" name="companyName" th:value="${companyName}" />

            <div class="mb-3">
              <label class="form-label">Bedrijfsnaam</label>
              <input
                type="text"
                class="form-control"
                th:value="${companyName}"
                disabled
              />
            </div>

            <div class="mb-3">
              <label class="form-label">Locatie (stad/regio) *</label>
              <input
                type="text"
                name="location"
                class="form-control"
                th:value="${company.location}"
                placeholder="Bijv. Groningen"
                required
              />
            </div>

            <div class="mb-3">
              <label class="form-label">Website-URL</label>
              <input
                type="url"
                name="websiteUrl"
                class="form-control"
                th:value="${company.websiteUrl}"
                placeholder="https://www.bedrijf.nl"
              />
            </div>

            <div class="mb-3">
              <label class="form-label">Over ons *</label>
              <textarea
                name="aboutUs"
                class="form-control"
                rows="4"
                required
                placeholder="Beschrijf wie jullie zijn..."
                th:text="${company.aboutUs}"
              ></textarea>
            </div>

            <div class="mb-3">
              <label class="form-label"
                >Bedrijfslogo (JPG, PNG; max. 5MB)</label
              >
              <input
                type="file"
                name="logo"
                class="form-control"
                accept=".jpg,.jpeg,.png"
              />
              <small class="text-muted"
                >Ondersteunde formaten: JPG, PNG. Maximaal 5MB.</small
              >
              <div th:if="${company.logo}" class="mt-2">
                <small class="text-muted">Huidig logo:</small><br />
                <img
                  th:src="@{'/api/company/logo/' + ${company.id}}"
                  alt="Logo"
                  class="img-fluid mt-2"
                  style="max-width: 150px; border-radius: 8px"
                />
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Gezochte genres</label>
              <div
                class="border rounded p-3"
                style="max-height: 200px; overflow-y: auto"
              >
                <div th:each="genre : ${genresOptions}" class="form-check">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    name="genres"
                    th:value="${genre}"
                    th:id="${'genre-' + genre}"
                    th:checked="${company.genres != null && #strings.contains(company.genres, genre)}"
                  />
                  <label
                    class="form-check-label"
                    th:for="${'genre-' + genre}"
                    th:text="${genre}"
                  ></label>
                </div>
              </div>
              <small class="text-muted"
                >Selecteer een of meer genres waarin jullie muzikanten
                zoeken</small
              >
            </div>

            <div class="mb-3">
              <label class="form-label">Gezochte muzikanten *</label>
              <textarea
                name="musiciansWanted"
                class="form-control"
                rows="5"
                required
                placeholder="Beschrijf welke muzikanten jullie zoeken (ervaring, instrumenten, genre, etc.)"
                th:text="${company.musiciansWanted}"
              ></textarea>
            </div>

            <button type="submit" class="btn btn-primary">Opslaan</button>
            <a
              th:href="@{'/profile/' + ${companyName}}"
              class="btn btn-secondary"
              >Annuleren</a
            >
          </form>
        </div>
      </div>
    </div>

    <!-- Event aanmaken sectie (alleen als bedrijf data heeft en NIET in edit mode) -->
    <div
      th:if="${hasData != null && hasData == true && edit != null && edit == false}"
      class="container mt-4"
    >
      <!-- Events Table -->
      <div
        class="card shadow-sm mb-4"
        th:if="${companyEvents != null && #lists.size(companyEvents) > 0}"
      >
        <div
          class="card-header bg-light d-flex justify-content-between align-items-center"
        >
          <h5
            class="mb-0"
            th:text="${isOwner ? 'üìã Jouw Events' : 'üìã Events'}"
          >
            üìã Events
          </h5>
          <button
            th:if="${isOwner}"
            type="button"
            class="btn btn-primary btn-sm"
            data-bs-toggle="modal"
            data-bs-target="#addEventModal"
          >
            <i class="bi bi-plus-circle"></i> Event Aanmaken
          </button>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead class="table-light">
                <tr>
                  <th>Titel</th>
                  <th>Beschrijving</th>
                  <th>Instrumenten</th>
                  <th>Genres</th>
                  <th>Locatie</th>
                  <th th:if="${isOwner}">Acties</th>
                </tr>
              </thead>
              <tbody>
                <tr th:each="event : ${companyEvents}">
                  <td>
                    <a
                      th:href="@{'/event/' + ${event.id}}"
                      th:text="${event.title}"
                      class="text-decoration-none"
                      >Event Title</a
                    >
                  </td>
                  <td>
                    <span
                      th:text="${#strings.abbreviate(event.description, 50)}"
                      class="text-muted"
                      >Description</span
                    >
                  </td>
                  <td>
                    <span
                      th:if="${event.instruments != null && !event.instruments.isEmpty()}"
                      th:each="instrument : ${event.instruments}"
                      class="badge bg-primary me-1"
                      th:text="${instrument.naam}"
                    ></span>
                    <span
                      th:if="${event.instruments == null || event.instruments.isEmpty()}"
                      class="text-muted"
                      >-</span
                    >
                  </td>
                  <td>
                    <span
                      th:if="${event.genres != null && !event.genres.isEmpty()}"
                      th:each="genre : ${event.genres}"
                      class="badge bg-secondary me-1"
                      th:text="${genre.name}"
                    ></span>
                    <span
                      th:if="${event.genres == null || event.genres.isEmpty()}"
                      class="text-muted"
                      >-</span
                    >
                  </td>
                  <td>
                    <small class="badge bg-info">
                      <span
                        th:text="${#numbers.formatDecimal(event.lat, 1, 4)}"
                      ></span
                      >,
                      <span
                        th:text="${#numbers.formatDecimal(event.lng, 1, 4)}"
                      ></span>
                    </small>
                  </td>
                  <td th:if="${isOwner}">
                    <form
                      method="post"
                      th:action="@{'/event/' + ${event.id} + '/delete'}"
                      style="display: inline"
                      onsubmit="
                        return confirm(
                          'Weet je zeker dat je dit event wilt verwijderen?',
                        );
                      "
                    >
                      <button type="submit" class="btn btn-sm btn-danger">
                        üóëÔ∏è Verwijderen
                      </button>
                    </form>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div
        class="card shadow-sm mb-4"
        th:if="${companyEvents == null || #lists.size(companyEvents) == 0}"
      >
        <div
          class="card-header bg-light d-flex justify-content-between align-items-center"
        >
          <h5
            class="mb-0"
            th:text="${isOwner ? 'üìã Jouw Events' : 'üìã Events'}"
          >
            üìã Events
          </h5>
          <button
            th:if="${isOwner}"
            type="button"
            class="btn btn-primary btn-sm"
            data-bs-toggle="modal"
            data-bs-target="#addEventModal"
          >
            <i class="bi bi-plus-circle"></i> Event Aanmaken
          </button>
        </div>
        <div class="card-body text-center py-4">
          <p class="text-muted mb-0">Je hebt nog geen events aangemaakt.</p>
        </div>
      </div>
    </div>

    <!-- Add Event Modal (only for profile owner) -->
    <div
      th:if="${isOwner}"
      th:insert="~{fragments/_addEventModal :: addEventModal}"
    ></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script th:inline="javascript">
      const currentCompanyUserId = /*[[${company.user.id}]]*/ null;

      let eventMap;
      let eventMarker;

      // Initialize event map when modal is shown
      document
        .getElementById("addEventModal")
        .addEventListener("shown.bs.modal", function () {
          if (!eventMap) {
            initializeEventMap();
          } else {
            eventMap.invalidateSize();
          }
        });

      function initializeEventMap() {
        const mapContainer = document.getElementById("eventMap");
        if (!mapContainer) {
          console.warn("Event map container not found");
          return;
        }

        // Define bounds for Netherlands
        const maxBounds = L.latLngBounds(
          L.latLng(50.75, 3.5),
          L.latLng(53.7, 8.0),
        );

        // Create map
        eventMap = L.map("eventMap", {
          maxBounds: maxBounds,
          maxBoundsViscosity: 1.0,
        }).setView([53.2194, 6.5665], 12);

        eventMap.setMaxBounds(maxBounds);

        // Add tile layer
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          maxZoom: 19,
          attribution: "&copy; OpenStreetMap contributors",
          className: "map-tiles",
        }).addTo(eventMap);

        // Custom pin icon
        const pinIcon = L.icon({
          iconUrl: "/assets/pin-red.png",
          iconSize: [25, 40],
          iconAnchor: [12, 40],
          popupAnchor: [1, -34],
          shadowUrl: "/assets/pin-shadow.png",
          shadowSize: [41, 41],
          shadowAnchor: [13, 41],
        });

        // Map click handler
        eventMap.on("click", function (event) {
          const lat = event.latlng.lat.toFixed(6);
          const lng = event.latlng.lng.toFixed(6);

          // Update form fields
          document.getElementById("eventLat").value = lat;
          document.getElementById("eventLng").value = lng;

          // Remove previous marker
          if (eventMarker) {
            eventMap.removeLayer(eventMarker);
          }

          // Add new marker
          eventMarker = L.marker([lat, lng], { icon: pinIcon })
            .addTo(eventMap)
            .bindPopup(
              "Geselecteerde locatie<br>Lat: " + lat + "<br>Lng: " + lng,
            )
            .openPopup();
        });
      }

      // Event form submission handler for modal
      const eventForm = document.getElementById("addEventForm");
      if (eventForm) {
        eventForm.addEventListener("submit", async (e) => {
          e.preventDefault();

          // Collect form data
          const title = document.getElementById("eventTitle").value;
          const description = document.getElementById("eventDescription").value;
          const lat = parseFloat(document.getElementById("eventLat").value);
          const lng = parseFloat(document.getElementById("eventLng").value);

          // Collect selected instrument IDs
          const instrumentCheckboxes = document.querySelectorAll(
            ".event-instrument-checkbox:checked",
          );
          const instrumentIds = Array.from(instrumentCheckboxes).map((cb) =>
            parseInt(cb.value),
          );

          // Collect selected genre IDs
          const genreCheckboxes = document.querySelectorAll(
            ".event-genre-checkbox:checked",
          );
          const genreIds = Array.from(genreCheckboxes).map((cb) =>
            parseInt(cb.value),
          );

          const data = {
            title: title,
            description: description,
            lat: lat,
            lng: lng,
            companyUserId: currentCompanyUserId,
            instrumentIds: instrumentIds,
            genreIds: genreIds,
          };

          try {
            const response = await fetch("/api/events/add", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(data),
            });

            if (!response.ok) throw new Error("Request failed");

            const savedEvent = await response.json();

            // Reset form
            eventForm.reset();
            document.getElementById("eventLat").value = "";
            document.getElementById("eventLng").value = "";

            // Clear marker
            if (eventMarker && eventMap) {
              eventMap.removeLayer(eventMarker);
              eventMarker = null;
            }

            // Close modal
            const modal = bootstrap.Modal.getInstance(
              document.getElementById("addEventModal"),
            );
            if (modal) modal.hide();

            // Reload page to show new event
            setTimeout(() => {
              location.reload();
            }, 500);
          } catch (error) {
            console.error("Error:", error);
            alert("Fout bij opslaan. Probeer opnieuw.");
          }
        });
      }
    </script>
  </body>
</html>
